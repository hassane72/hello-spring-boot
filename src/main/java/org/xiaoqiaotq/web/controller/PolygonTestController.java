package org.xiaoqiaotq.web.controller;

import com.vividsolutions.jts.geom.Geometry;
import com.vividsolutions.jts.geom.MultiPolygon;
import com.vividsolutions.jts.io.ParseException;
import com.vividsolutions.jts.io.WKTReader;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.xiaoqiaotq.domain.geom.StreetTest;
import org.xiaoqiaotq.repository.StreetRepository;
import org.xiaoqiaotq.service.StreetService;

import java.io.InputStream;
import java.util.List;

/**
 * author: xiaoqiaotq@gmail.com
 * date  : 2015/10/15
 */
@Controller
public class PolygonTestController {
    @Autowired
    StreetRepository streetRepository;

    public static final String gem = "MULTIPOLYGON (((116.645936 39.891457, 116.65604100000019 39.888174000000106, 116.67667500000016 39.87179900000007, 116.68776200000002 39.868813999999986, 116.68977499999994 39.86339200000009, 116.68781000000014 39.8613180000001, 116.69173999999998 39.860225999999955, 116.69370500000001 39.852693000000045, 116.69283199999994 39.851274000000046, 116.68824700000006 39.85280300000006, 116.66641200000016 39.854549000000134, 116.66412000000003 39.851602000000014, 116.66149507486693 39.85103122774882, 116.66121552000004 39.85107075000025, 116.66067228000018 39.85113465000023, 116.66027178000014 39.85115269500022, 116.65978038000014 39.85113838500007, 116.65767130863718 39.850985563787674, 116.64370499999997 39.85564100000005, 116.63842401862314 39.85628519477933, 116.63801586000021 39.85635069000017, 116.63689662000014 39.85655211000011, 116.63563643999998 39.85677549000013, 116.63436564000017 39.85701187500024, 116.63304930000017 39.85725703500009, 116.63168958000006 39.85750876500015, 116.63039502000028 39.8577994650002, 116.62905744000024 39.85808895000025, 116.62770456000021 39.85838257500012, 116.62634934000016 39.85867831500025, 116.62502886000016 39.858974100000125, 116.62371486000018 39.85930458000013, 116.62237277999998 39.859630740000114, 116.62113474000022 39.8599720200001, 116.62057529999993 39.860174115000234, 116.62054506000027 39.86018716500024, 116.62051248000024 39.86020449000017, 116.62048638000022 39.86022406500007, 116.62047126000004 39.8602458000002, 116.62046478000002 39.86026749000024, 116.62046478000002 39.860308710000254, 116.62047558000017 39.86034560999991, 116.62049520000004 39.860382510000136, 116.62051248000024 39.86041072500024, 116.62075746000028 39.86068837499994, 116.62087230000031 39.86082504000018, 116.62088328000016 39.86084241000021, 116.62088976000018 39.86086194000018, 116.62088976000018 39.860885790000225, 116.62088760000019 39.86090748000004, 116.62087878 39.860933535000186, 116.62086366000015 39.86095527000009, 116.62082892000011 39.86098132500024, 116.62075314000026 39.861022590000175, 116.62029558000006 39.86129628000026, 116.61968196000008 39.861645930000236, 116.61919200000024 39.86192398500003, 116.61865434000015 39.862223730000096, 116.61822270000015 39.862532069999986, 116.61810804000025 39.862647180000124, 116.61803640000016 39.86282083500021, 116.61792588000026 39.86361085500017, 116.61783030000016 39.864207690000114, 116.61771114000011 39.86508015000015, 116.61744294000027 39.866405175000125, 116.61741684000025 39.86658076499987, 116.61740568000003 39.86665447500013, 116.61739056000022 39.866693490000046, 116.61732522000011 39.86674767000011, 116.61726006000028 39.866775795000194, 116.61720354000033 39.86678007000012, 116.61638670000025 39.8667098700002, 116.61532452000016 39.86661122999999, 116.61508764000008 39.866591475000234, 116.61499656000002 39.866597865000244, 116.61493554000027 39.86662383000015, 116.6149008000001 39.86664984000021, 116.61481151999999 39.8667711600001, 116.6145174000002 39.8674561050002, 116.6145219 39.86752977000015, 116.61482304000037 39.86815459500025, 116.61560334000012 39.86980551000016, 116.61563808000017 39.86985105000019, 116.61569010000018 39.86989452000023, 116.61627402000022 39.8703525750002, 116.6164889400002 39.87057834000018, 116.61664518000032 39.87074758500023, 116.61670152000022 39.87081054000021, 116.61699636000027 39.87130959000007, 116.61720088935444 39.871704026058296, 116.61748200000012 39.87191200000001, 116.61786300000004 39.87217099999992, 116.61820599999997 39.872806999999966, 116.6186560000001 39.87368200000009, 116.61873700000001 39.87386700000013, 116.61895400000003 39.874352999999985, 116.61906499999999 39.87465000000009, 116.61910999999999 39.87477000000007, 116.619194 39.875052000000096, 116.61920199999997 39.8750950000001, 116.61934800000017 39.87580900000006, 116.61945100000014 39.87632000000002, 116.61953800000003 39.8766940000001, 116.61965299999997 39.87711900000005, 116.619782 39.87760500000013, 116.61990800000012 39.878144000000134, 116.62028599999996 39.87974900000006, 116.62035500000003 39.87997999999999, 116.62038900000016 39.880061000000126, 116.62040000000013 39.880087, 116.62043900000003 39.88013500000005, 116.62048800000015 39.88018599999998, 116.62054500000012 39.88022600000011, 116.62060300000006 39.880251000000044, 116.620637 39.88026099999996, 116.62067899999998 39.88026900000011, 116.62072100000013 39.88027599999998, 116.62084300000005 39.88028700000001, 116.62257499999997 39.880416000000025, 116.62371199999997 39.88062000000002, 116.62394800000004 39.880648000000015, 116.62410799999998 39.88065799999998, 116.62443999999995 39.88066300000003, 116.62472600000001 39.88066300000003, 116.62472200000002 39.88073900000012, 116.62471100000015 39.88094000000001, 116.62471100000015 39.88102200000009, 116.62474899999995 39.88114900000011, 116.6247420000001 39.88123999999999, 116.62461900000017 39.88182300000011, 116.62410799999998 39.883939, 116.62316899999996 39.888643, 116.61920199999997 39.88876499999998, 116.61444900000016 39.888899999999985, 116.61330800000007 39.88882100000001, 116.61222499999997 39.888760000000104, 116.61083300000006 39.88865499999997, 116.60997400000008 39.888589000000024, 116.608605 39.88847499999997, 116.60870399999999 39.89083199999993, 116.645936 39.891457), (116.67257532000008 39.87211342500024, 116.67311856000028 39.87209506500017, 116.67343031999998 39.87212926500013, 116.67351906000022 39.87216594000023, 116.67359484000006 39.87220270500018, 116.67364452000027 39.87225904500002, 116.67368123999995 39.87234796500013, 116.67369636000012 39.872462940000105, 116.67369420000011 39.87256711500015, 116.67359052000008 39.87284724000011, 116.67346038000026 39.873101399999996, 116.67338046000009 39.87320350500022, 116.67327210000018 39.87333175500015, 116.67292794000012 39.87356674500023, 116.67231558000026 39.8739953700001, 116.67208410000012 39.874178070000085, 116.67176784000026 39.87449329500015, 116.67147588000022 39.874825845000146, 116.67135006000014 39.874932405000095, 116.67121380000027 39.874997745000144, 116.67068352000022 39.875035635000074, 116.67029184000002 39.87506884500016, 116.67017718000011 39.87506907000011, 116.67009708000023 39.875023665000185, 116.67004506 39.87492826500011, 116.67006036000022 39.87483925500022, 116.67009492000024 39.874695975000236, 116.67015558000026 39.874355145000095, 116.67028121999999 39.87371695500025, 116.67038724000007 39.87321763500012, 116.67048246000013 39.872640195000145, 116.67053232000002 39.87256630500025, 116.67058866000004 39.872518515000195, 116.67067938000027 39.872492280000245, 116.67082446000019 39.8724746850001, 116.6711297400002 39.87247410000015, 116.67125520000015 39.87247387500026, 116.67159072000015 39.87242122500015, 116.6718524400003 39.872340405000216, 116.67211866000014 39.872207610000146, 116.67235896000011 39.872142045000146, 116.67257532000008 39.87211342500024)), ((116.61481620000018 39.86652181500017, 116.61488154000006 39.866474205000145, 116.61498144000018 39.86644387500013, 116.61507269999994 39.86644396499992, 116.6167366200001 39.86658229500017, 116.61714954000011 39.866621715000235, 116.61719940000035 39.86661096000017, 116.61722118000024 39.86658494999995, 116.61752898000009 39.864869774999875, 116.61768954000024 39.8638040850002, 116.61776081999994 39.863024955000185, 116.61779123999996 39.862862145000236, 116.61782166000002 39.86272327500012, 116.61786072000018 39.86264727000014, 116.61796691999997 39.862475775000235, 116.61808842000005 39.86235639000023, 116.61852420000037 39.86204584500018, 116.61919200000024 39.86167441500021, 116.62043435999999 39.86100971999997, 116.62055586000008 39.860935875000166, 116.62059690000012 39.86090113500018, 116.62060769999994 39.86087292000002, 116.62060769999994 39.86082949500025, 116.62060122000014 39.86079696000014, 116.62058628000011 39.86076442500002, 116.6205623400001 39.860729685000194, 116.62030872000025 39.86037823500021, 116.62026534000005 39.86031316499998, 116.6202500400002 39.86027626500015, 116.6202500400002 39.8602393650001, 116.62026534000005 39.86020462499988, 116.6202739800002 39.86017209000016, 116.6202696600002 39.86013519000011, 116.6202500400002 39.86010265500016, 116.62022844 39.86007876000025, 116.6202045 39.86006143500015, 116.6201827200001 39.860046270000225, 116.62015032000012 39.8600375850001, 116.62009830000022 39.86004411000022, 116.61997896000014 39.86007021000023, 116.61933924000016 39.86024629500014, 116.61919200000024 39.860285445000216, 116.61885162000011 39.860357220000196, 116.61873660000002 39.8603529450001, 116.61762438000017 39.86011903500008, 116.617288663963 39.86003297688035, 116.6172150000001 39.860268000000076, 116.61710800000004 39.86092100000013, 116.61702400000001 39.86109400000004, 116.6168530000001 39.86139399999996, 116.61644000000001 39.86221599999999, 116.61620700000014 39.86278600000003, 116.61608899999997 39.863072999999986, 116.61552100000004 39.86439000000007, 116.61493700000005 39.86564699999997, 116.61448700000015 39.86650099999997, 116.61286600000005 39.866214000000014, 116.61201100000007 39.86606599999999, 116.61097000000007 39.86806899999999, 116.61143100000004 39.868217000000016, 116.61188500000014 39.86837900000006, 116.61224800000014 39.86851200000007, 116.61337700000011 39.86887500000006, 116.61694599984152 39.87151545128347, 116.61685074000013 39.87133110000025, 116.61659064000024 39.87085599000022, 116.61654942000007 39.870799559999966, 116.61618276000011 39.870408870000176, 116.61557274000006 39.86992471499997, 116.6155228800002 39.869874810000226, 116.6144022000002 39.867523200000164, 116.61438726000006 39.86746681500017, 116.61440238000023 39.86741259000024, 116.61472062000006 39.8666713049999, 116.61481620000018 39.86652181500017)), ((116.61919200000024 39.86014221000016, 116.61975773999997 39.859974855000246, 116.62016975999995 39.85989434999988, 116.62067286000001 39.85979427000012, 116.62117596000006 39.85968555000022, 116.62179804000004 39.85953120000022, 116.6227630200001 39.85930282499987, 116.62440876000005 39.85891141500019, 116.62592238000036 39.858530939999866, 116.62635227096611 39.85843174702535, 116.62111400000002 39.859491000000105, 116.620725 39.85967700000003, 116.62036599999999 39.85976600000009, 116.61920999999995 39.86004900000006, 116.61898899999994 39.860100000000045, 116.61871399999995 39.86013100000014, 116.61848099999997 39.86009699999994, 116.61782900000004 39.85995000000008, 116.61734100000002 39.85986600000001, 116.61732051033596 39.859931371785365, 116.61868692000019 39.86020971000022, 116.61881040000027 39.86023135500017, 116.61886026000013 39.86023347000025, 116.61893604000035 39.860220420000246, 116.61919200000024 39.86014221000016)), ((116.63472369822638 39.8567389252359, 116.63476189019524 39.856731915539285, 116.63475300000003 39.85673299999996, 116.63472369822638 39.8567389252359)), ((116.65983646269581 39.850670573728394, 116.65909799999997 39.85051000000004, 116.65876062599659 39.85062245800117, 116.65972422000026 39.85066759500023, 116.65983646269581 39.850670573728394)))";
    @RequestMapping("/testPolygon")
    public void testPolygon(){

        StreetTest street=new StreetTest();
        Geometry geometry = wktToGeometry(gem);
        System.err.println(geometry.getGeometryType());
        street.setAliasName("dsafsadf");
        street.setNameEn("地方");
        street.setCity("北京");
        street.setProvince("北京省");
        street.setDistrict("xx区");
        street.setGeom((MultiPolygon) geometry);
        streetRepository.save(street);

    }
    @RequestMapping("/testPolygonLoad")
    @ResponseBody
    public StreetTest testPolygonLoad(){

        return streetRepository.findOne(1l);

    }

    private Geometry wktToGeometry(String wktPoint) {
        WKTReader fromText = new WKTReader();
        Geometry geom = null;
        try {
            geom = fromText.read(wktPoint);
        } catch (ParseException e) {
            throw new RuntimeException("Not a WKT string:" + wktPoint);
        }
        System.err.println(geom.getGeometryType());
        return geom;
    }

    public static void main(String[] args) {
        PolygonTestController sampleController=new PolygonTestController();
        Geometry geometry = sampleController.wktToGeometry(gem);
    }

    @Autowired
    private StreetService streetService;

    @RequestMapping("/import")
    @ResponseBody
    public  String streetImport(MultipartFile zipFile)throws Exception{
        InputStream in = zipFile.getInputStream();
        streetService.importFile(in);
        return "success";
    }
    @RequestMapping("/query")
    @ResponseBody
    public List<StreetTest> queryStreet(@RequestParam String citycode){
        List<StreetTest> streets = streetService.queryStreet(citycode);
        return streets;
    }
}